# Standalone Relative Visibility Heatmap Generator

This tool allows you to generate relative visibility heatmaps from existing simulation data without re-running the full simulation. It's designed to work with the CSV visibility count files produced by the FTO-Sim ray tracing simulation.

## Overview

The standalone heatmap generator can:
- Generate heatmaps from existing visibility count CSV files
- Include the same geospatial background layers as the main simulation
- Allow customization of visualization parameters
- Work offline after simulation data has been collected
- Support batch processing of multiple scenarios

## Requirements

### Python Dependencies
- pandas
- numpy
- matplotlib
- geopandas
- osmnx
- pyproj

### Input Data Required
1. **Visibility counts CSV file** - Generated by the main simulation
   - Location: `out_visibility/visibility_counts/visibility_counts_{file_tag}_FCO{X}%_FBO{Y}%.csv`
   - Contains columns: `x_coord`, `y_coord`, `visibility_count`

2. **GeoJSON file** (optional) - Road space distribution
   - Usually located in `SUMO_example/SUMO_example.geojson`
   - Contains road network geometry

3. **Configuration parameters**:
   - Bounding box coordinates (north, south, east, west)
   - Grid size used in original simulation
   - File tags and penetration rates
   - Visualization preferences

## Usage Methods

### Method 1: Using Configuration File (Recommended)

1. Copy and modify the example configuration:
   ```bash
   cp heatmap_config_example.json my_config.json
   ```

2. Edit `my_config.json` with your parameters:
   ```json
   {
     "bbox": [48.15050, 48.14905, 11.57100, 11.56790],
     "grid_size": 0.5,
     "file_tag": "ETRR",
     "FCO_share": 50,
     "FBO_share": 0,
     ...
   }
   ```

3. Run the generator:
   ```bash
   python generate_heatmap_standalone.py --config my_config.json
   ```

### Method 2: Command Line Parameters

```bash
python generate_heatmap_standalone.py \
  --bbox 48.15050 48.14905 11.57100 11.56790 \
  --grid-size 0.5 \
  --file-tag ETRR \
  --fco-share 50 \
  --fbo-share 0
```

### Method 3: Windows Batch File (Simple)

1. Edit the batch file `generate_heatmap.bat` with your parameters
2. Double-click the batch file to run

## Configuration Parameters

### Essential Parameters
- `bbox`: Bounding box coordinates [north, south, east, west] in WGS84
- `grid_size`: Grid cell size in meters (must match original simulation)
- `file_tag`: Identifier used in file names
- `FCO_share`: FCO penetration rate (0-100)
- `FBO_share`: FBO penetration rate (0-100)

### Path Configuration
- `base_dir`: Base directory of FTO-Sim project (auto-detected if null)
- `geojson_path`: Path to GeoJSON file (auto-detected if null)
- `visibility_csv_path`: Path to CSV file (auto-detected if null)
- `output_dir`: Output directory for heatmap (auto-detected if null)

### Visualization Options
- `include_roads`: Include road space distribution (default: true)
- `include_buildings`: Include buildings from OpenStreetMap (default: true)
- `include_parks`: Include parks (default: true)
- `include_trees`: Include trees (default: true)
- `include_barriers`: Include barriers/walls (default: true)
- `include_pt_shelters`: Include PT shelters (default: false)
- `colormap`: Matplotlib colormap name (default: 'hot')
- `figure_size`: Figure size [width, height] (default: [12, 8])
- `dpi`: Output resolution (default: 300)
- `alpha`: Heatmap transparency (default: 0.6)

## File Structure Expected

```
FTO-Sim/
├── Scripts/
│   ├── generate_heatmap_standalone.py
│   ├── heatmap_config_example.json
│   └── generate_heatmap.bat
├── SUMO_example/
│   └── SUMO_example.geojson
├── out_visibility/
│   ├── visibility_counts/
│   │   └── visibility_counts_ETRR_FCO50%_FBO0%.csv
│   └── (generated heatmaps will be saved here)
└── ...
```

## Examples

### Generate heatmap with different visualization settings
```bash
python generate_heatmap_standalone.py \
  --config my_config.json \
  --fco-share 25 \
  --fbo-share 10
```

### Batch process multiple scenarios
```bash
# Create heatmaps for different penetration rates
for fco in 0 25 50 75 100; do
  python generate_heatmap_standalone.py \
    --config base_config.json \
    --fco-share $fco \
    --fbo-share 0
done
```

### Save configuration for future use
```bash
python generate_heatmap_standalone.py \
  --bbox 48.15050 48.14905 11.57100 11.56790 \
  --grid-size 0.5 \
  --file-tag ETRR \
  --save-config my_scenario.json
```

## Troubleshooting

### Common Issues

1. **CSV file not found**
   - Ensure the visibility counts CSV exists in `out_visibility/visibility_counts/`
   - Check that file_tag and penetration rates match the original simulation

2. **Missing geospatial data**
   - The generator will warn but continue if optional data is missing
   - Buildings and roads require internet connection to download from OpenStreetMap

3. **Coordinate system issues**
   - Ensure the bounding box matches the original simulation
   - Check that grid_size matches the original simulation

4. **Memory issues with large grids**
   - Consider using a larger grid_size for faster processing
   - Reduce figure DPI if memory is limited

### Error Messages

- `"Visibility CSV path not specified"`: The CSV file couldn't be auto-detected
- `"Required column not found"`: CSV format is incorrect or corrupted
- `"Could not load buildings/parks"`: OpenStreetMap data unavailable (optional)

## Advanced Usage

### Creating Custom Visualizations

You can modify the `StandaloneHeatmapGenerator` class to:
- Add new background layers
- Change color schemes
- Add annotations or legends
- Export data in different formats

### Integration with Other Tools

The generator can be imported as a module:

```python
from generate_heatmap_standalone import StandaloneHeatmapGenerator

generator = StandaloneHeatmapGenerator(
    bbox=[48.15050, 48.14905, 11.57100, 11.56790],
    file_tag='ETRR',
    FCO_share=50,
    FBO_share=0
)
generator.generate_heatmap()
```

## Performance Notes

- **First run**: Downloads OpenStreetMap data (requires internet)
- **Subsequent runs**: Uses cached OSM data (faster)
- **Large grids**: Processing time scales with grid size squared
- **Memory usage**: Proportional to grid resolution and number of geospatial features

## Output

The generator produces:
- High-resolution PNG heatmap image
- Console progress information
- Error/warning messages for missing data

Output filename format: `relative_visibility_heatmap_FCO{X}%_FBO{Y}%.png`
